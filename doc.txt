USER-DOKUMENTATION – Cloudflare Worker „Intervals Daily Sync“
=============================================================

1) ZWECK & ÜBERBLICK
-------------------
Dieser Worker synchronisiert Intervals.icu-Daten (Aktivitäten + Streams) in Wellness-Felder,
erzeugt tägliche und montägliche NOTE-Events und liefert ein kompaktes Watchface-JSON.

Hauptfunktionen:
- `/sync`: berechnet pro Tag Kennzahlen und schreibt (optional) Wellness + NOTE-Events
- `/watchface`: liefert 7-Tage-Load/Kraft-Minuten als JSON (CORS offen, no-store)
- `scheduled()`: triggert automatischen Sync für gestern + heute (mit `write=true`)

Pro verarbeitetem Tag:
- Wellness-Kommentar wird geleert (`comments = ""`)
- numerische Felder werden gesetzt, wenn Daten vorhanden sind:
  - `VDOT`, `EF`, `Drift`, `Motor`, `Block`
- tägliches NOTE-Event `Daily-Report` wird geschrieben/aktualisiert
- montags zusätzlich `Montags-Report` (Detective-Note)

2) VORAUSSETZUNGEN
------------------
Plattform:
- Cloudflare Worker (Module Worker, `export default { fetch, scheduled }`)

Environment / Secrets:
- `INTERVALS_API_KEY` (Secret)
- `ATHLETE_ID` (required env var)
- `KV` (KV Namespace Binding für Detective-Historie)

Auth:
- Authorization Header: `Basic ` + base64(`API_KEY:<INTERVALS_API_KEY>`)

3) INTERVALS.ICU SETUP
----------------------
3.1 Wellness Custom Numeric Fields
In Intervals.icu müssen diese Codes als Numeric Fields existieren:
- `VDOT`
- `Drift`
- `Motor`
- `EF`
- `Block`

4) ENDPOINTS
------------
4.1 Health
- `GET /`
- Antwort: `ok`

4.2 Watchface
- `GET /watchface`
- optional: `?date=YYYY-MM-DD`
- Antwort: JSON mit 7-Tage-Zeitraum inkl.:
  - `days[]`
  - `runLoad[]`, `runSum7`, `runGoal` (aktuell 150)
  - `strengthMin[]`, `strengthSum7`, `strengthGoal` (aktuell 60)
  - `updatedAt`
- Header:
  - `cache-control: no-store`
  - `access-control-allow-origin: *`
- `OPTIONS /watchface` liefert CORS-Preflight (`204`)

4.3 Sync
- `GET /sync`

Range-Parameter:
- `date=YYYY-MM-DD` (einzelner Tag)
- `from=YYYY-MM-DD&to=YYYY-MM-DD` (expliziter Bereich)
- sonst `days=14` (Default, clamp 1..31)

Weitere Parameter:
- `write=true|false`
  - `true`: schreibt Wellness + NOTE-Events
  - `false`: nur Berechnung/Preview
- `debug=true|false`
  - `true`: synchron, liefert umfangreiches JSON (`patches`, `debug`, `notesPreview`)
  - `false`: asynchron via `waitUntil`, Response sofort
- `warmup_skip=600` (Sekunden, clamp 0..1800)

Validierung:
- Datumsformat muss `YYYY-MM-DD` sein
- `to >= from`
- max Range = 31 Tage

Beispiele:
- `/sync?date=2026-01-20&write=true&debug=true`
- `/sync?days=7&write=false&debug=true`
- `/sync?from=2026-01-01&to=2026-01-14&write=true&warmup_skip=900`

5) SCHEDULED TRIGGER
--------------------
`scheduled()` verarbeitet:
- `oldest = gestern`
- `newest = heute`
- intern mit `write=true`, `debug=false`, `warmup_skip=600`

Hinweis: Die tatsächlichen Cron-Zeiten stehen in `wrangler.toml` (aktuell zwei Läufe pro Tag).

6) KLASSIFIKATIONEN
-------------------
6.1 Sportarten
- Run: `type` enthält run/running/laufen
- Bike: `type` enthält ride/bike/cycling/rad/velo
- Strength: type- oder tag-basierte Erkennung (`strength`, `kraft`, `gym`, `core`, ...)

6.2 Key-Training
- Aktivität ist Key, wenn mindestens ein Tag mit Präfix `key:` existiert
- Beispiel: `key:vo2`, `key:schwelle`, `key:tempo`

6.3 GA / comparable GA
- GA: nicht Key und Dauer >= 30 min
- comparable GA: nicht Key und Dauer >= 35 min (+ Stabilitäts-/Qualitätskriterien)

7) KENNZAHLEN
-------------
7.1 EF (Efficiency Factor)
- `EF = average_speed / average_heartrate`
- fehlt eine Basisgröße -> `null`

7.2 VDOT-like
- `VDOT = EF * 1200`
- skaliertes Signal (kein offizieller VDOT)

7.3 Drift
Aus Streams (`time`, `velocity_smooth`, `heartrate`):
- Warmup-Skip standardmäßig 600s
- Filter: `HR >= 40`, `speed >= 1.8 m/s`
- Drift `% = ((hr2 - hr1) / hr1) * 100`
- Negative Drift wird verworfen (`null`)

7.4 Motor-Index
- Trendscore 0..100 auf Basis vergleichbarer GA-Läufe
- kombiniert EF- und Drift-Entwicklung (verschiedene Fenster)
- Stale-Logik: bei fehlender aktueller Messbasis wird Motor als nicht belastbar markiert

8) MODE / POLICY (EVENT vs OPEN)
---------------------------------
Der Worker ermittelt aus kommenden Events einen Modus:
- `EVENT:RUN` (run-spezifischer Floor)
- `EVENT:BIKE` (bike-spezifischer Floor)
- `OPEN` (kein harter spezifischer Floor)

Zusätzlich aktiv:
- Aerobic-Floor-Logik
- Overlays wie `NORMAL`, `DELOAD`, `TAPER`, `RECOVER_OVERLAY`
- dynamische Key-Caps (z. B. strenger bei Taper/Fatigue)

9) BLOCK-STEUERUNG & PROGRESSION
--------------------------------
Block-Feld (`Block`) nutzt Zustände wie:
- `BASE`, `BUILD`, `RACE`, `RESET`

Steuerung berücksichtigt u. a.:
- Event-Nähe (`weeksToEvent`)
- Lauf-/Bike-Load und Floors
- Fatigue-Signale (Ramp, Monotony, Strain, ACWR)
- Robustheit (Kraft/Stabi-Minuten)
- Key-Compliance + Key-Spacing

Im Daily-Report erscheinen daraus abgeleitete Empfehlungen inkl.
- nächster Key-Reiz
- Progressionshinweis (Wochenziel in Minuten)

9.1 Verhalten zwischen zwei Wettkämpfen (Beispiel: Ende März + Anfang Oktober)
-------------------------------------------------------------------------------
- Nach **jedem** Wettkampf startet der Worker für 14 Tage einen offenen Modus (`OPEN:POST_EVENT`).
- In diesen 2 Wochen gibt es keine spezifischen Floors/Vorgaben ("Training nach Lust und Laune").
- Technisch wird dafür das kommende Event in dieser Phase bewusst nicht als aktives Ziel verwendet (`nextEvent = null`).
- Nach Ablauf der 14 Tage schaltet der Worker wieder normal auf den nächsten zukünftigen Wettkampf (z. B. Oktober) und läuft dann regulär in Richtung `BASE/BUILD/RACE`.
- Die bestehende Block-Logik (`RESET`/`BASE`) bleibt erhalten, greift aber erst wieder, wenn der offene 2‑Wochen-Block beendet ist.

9.2 Wenn der Wettkampf noch mehr als 24 Wochen entfernt ist
-----------------------------------------------------------
- Es gibt **keinen separaten Extra-Block** für `>24` Wochen Distanz zum Event.
- Die Blocklogik startet in der Regel in `BASE` (bei sehr großer Distanz oft mit `wave=1`) und arbeitet dann klassisch über `BUILD`/`RESET` weiter.
- Spezifisch für `>24` Wochen ist vor allem die Übergangsgewichtung von Bike zu Run:
  - Bei `weeksToEvent >= 24` zählt Bike mit Faktor `1.0` in die Aerobic-/Floor-Logik.
  - Zwischen 24 und 12 Wochen wird dieser Bike-Faktor linear reduziert.
  - Ab `<=12` Wochen ist Bike-Substitution auf `0.0` und der Fokus liegt vollständig auf laufspezifischer Vorbereitung.
- Praktisch bedeutet das: Frühe Phase = robuster Grundaufbau (`BASE`) mit hoher Bike-Anrechenbarkeit, später zunehmend laufspezifisch.

9.3 Heißt das „zweimal BASE→BUILD→RACE“?
-----------------------------------------
- **Nicht exakt.** Wenn genug Zeit bis zum Event ist, nutzt das System typischerweise eine 2‑Wellen-Logik:
  1. `BASE` (Wave 1) -> `BUILD` (Wave 1) -> `RESET`
  2. danach `BASE` (Wave 2) -> `BUILD` (Wave 2) -> `RACE`
- Der Zwischenblock `RESET` trennt die Wellen bewusst (Entlastung/Neuaufbau), daher ist es nicht einfach zweimal derselbe reine `BASE->BUILD->RACE`-Durchlauf.
- Wenn die Event-Nähe es erzwingt (z. B. <=6 Wochen), wird direkt in `RACE` gewechselt und die zweite Welle kann verkürzt/übersprungen werden.

9.4 Vorschlag (ohne Coding): freie Vorphase bis 24 Wochen + klarer Renn-Start
-------------------------------------------------------------------------
Zielbild für die Planung:
- Bis **>24 Wochen** vor Event: freierer Modus („Spaß haben, Form halten“), mit klaren Leitplanken.
- Ab **24 Wochen** vor Event: Start des bekannten Systems `BASE -> BUILD -> RACE`.

Regeltabelle (fachlich):
1) Vorphase `weeksToEvent > 24`
   - Modus: frei / unspezifisch (keine harte Race-Spezifik)
   - Sportarten-Mix: **50% Laufen / 50% Rad** erlaubt
   - Intensität: primär locker/steady, nur wenig scharfe Keys
   - Mindest-Longrun über 14 Tage:
     - 5k/10k: 45 min (Progression Richtung 60 min)
     - HM: 45 min (Progression Richtung 90 min)
     - Marathon: 45 min (Progression Richtung 120 min)

2) Übergangsfenster (optional fein): `48 -> 24 Wochen`
   - Run-Anteil progressiv steigern: **50% -> 80%**
   - Bike-Anteil entsprechend senken: **50% -> 20%**
   - Ziel: laufspezifischer werden, ohne abrupte Brüche.

3) Ab Startfenster `weeksToEvent <= 24`
   - Start des bekannten Systems: `BASE -> BUILD -> RACE`
   - Block-/Wave-Mechanik bleibt erhalten (`RESET` als Entlastungs-/Umschaltblock, falls ausgelöst).

4) Longrun-Zielkorridor bis zur 24-Wochen-Marke
   - 5k/10k: auf **60 min** anheben
   - HM: auf **90 min** anheben
   - Marathon: auf **120 min** anheben
   - Frequenz: mindestens **1 Lauf in 14 Tagen** im genannten Korridor.
   - Progression: **leichte Steigerung**, pro 14-Tage-Schritt maximal **+5%** Longrun-Dauer (Deckel).
   - Beispiel: 45 min -> 47 min -> 49 min -> 52 min ... bis zum distanzspezifischen Zielwert.

Hinweis zur Umsetzung im bestehenden Design:
- Die bestehende Bike->Run-Übergangslogik kann als technischer Hebel dienen, inhaltlich aber auf das neue Zielmodell ausgerichtet werden (Vorphase klarer „frei“, Start des Blocksystems fix bei 24 Wochen).

10) DAILY-REPORT NOTE
---------------------
Tägliches Event:
- `category: NOTE`
- `name: Daily-Report`
- `external_id: daily-report-YYYY-MM-DD`
- `start_date_local: YYYY-MM-DDT00:00:00`
- `color: blue`
- `description`: kompletter Tagesreport

11) MONTAGS-REPORT NOTE
-----------------------
Montags-Event:
- `category: NOTE`
- `name: Montags-Report`
- `external_id: detektiv-YYYY-MM-DD`
- `start_date_local: YYYY-MM-DDT00:00:00`
- `color: orange`
- `description`: Diagnose, Findings, Actions, Lastbild

Fensterauswahl adaptiv über mehrere Kandidaten (14..84 Tage),
zusätzlich Persistenz einer kompakten Summary in KV.

12) SCHREIBLOGIK / DEBUG
------------------------
- `write=false` schreibt nichts nach Intervals (nur Berechnung)
- `write=true` schreibt Wellness + NOTE-Events
- `debug=true` liefert:
  - `patches` je Tag
  - `debug` inkl. Aktivitätsklassifikation / Metrikhinweisen
  - `notesPreview` (Montags-Note Text)

13) WICHTIGE GRENZEN / HINWEISE
-------------------------------
- max Sync-Range: 31 Tage
- negative Drift wird nicht persistiert
- Representative-GA-Auswahl verhindert zufälliges Überschreiben numerischer Felder
- Monday-Check basiert auf ISO-Taglogik im Worker
- fehlende Streams/inkonsistente Aktivitäten werden im Debug sichtbar, aber nicht als Hard-Fail erzwungen

14) GLOSSAR
-----------
GA        = Grundlagenlauf (locker, nicht key, >=30 min)
Key       = intensive Einheit (Tag `key:*`)
EF        = Efficiency Factor (`speed / HR`)
VDOT-like = skaliertes EF-Signal (`EF*1200`)
Drift     = HR-Veränderung zwischen erster und zweiter Hälfte
Motor     = Trendscore aus EF/Drift-Entwicklung
Monotony  = mean(load) / std(load) über Tageslasten
Strain    = monotony * weekly load
ACWR      = acute/chronic workload ratio

ENDE
