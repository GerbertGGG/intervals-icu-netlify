USER-DOKUMENTATION ‚Äì Cloudflare Worker ‚ÄûIntervals Daily Sync‚Äú
=============================================================

1) ZWECK & √úBERBLICK
-------------------
Dieser Worker synchronisiert Daten aus Intervals.icu (Aktivit√§ten + Streams) in die
Wellness-Tage und erg√§nzt montags eine Kalender-Notiz (‚ÄûMontags-Detektiv‚Äú).

Pro Tag (im gew√§hlten Zeitraum):
- schreibt IMMER einen Wellness-Kommentar (auch wenn kein Lauf stattfindet)
- berechnet (wenn m√∂glich) GA-Kennzahlen:
  - VDOT (VDOT-like aus Efficiency-Factor)
  - Drift (HF-Drift aus Streams, optional mit Warmup-Skip)
- berechnet einen Motor-Index (0..100) als Trend-Indikator aus ‚Äûvergleichbaren‚Äú GA-L√§ufen
- zeigt IMMER einen Mindest-Laufreiz-Block (7-Tage Run-Load)
- erstellt montags eine Montags-Detektiv NOTE (Kalender-Event, Kategorie NOTE)
- erstellt an Bench-Tagen kurze Bench-Reports √ºber Tags ‚Äûbench:<name>‚Äú

2) VORAUSSETZUNGEN
------------------
Plattform:
- Cloudflare Worker (Modul-Worker: export default { fetch, scheduled })

Required Secret / Environment:
- INTERVALS_API_KEY

Auth-Mechanik:
- Authorization Header: "Basic " + base64("API_KEY:<INTERVALS_API_KEY>")

3) INTERVALS.ICU SETUP
----------------------
3.1 Wellness Custom Numeric Fields
In Intervals.icu musst du diese numeric custom fields anlegen (Codes exakt so):
- VDOT
- Drift
- Motor
- EF
- Block

Diese Felder werden in Wellness-Tagen gesetzt.

4) WAS GENAU WIRD GESCHRIEBEN?
------------------------------
4.1 Wellness pro Tag
F√ºr jeden Tag im Range wird mindestens geschrieben:
- comments (Wellness-Kommentar)

Optional, wenn ein GA-Lauf vorhanden und geeignet:
- VDOT (aus EF)
- EF (Efficiency Factor)
- Drift (HR-Drift % aus Streams)

Optional, wenn berechenbar:
- Motor (0..100)
- Block (aktuelle Block-Phase, z.B. BASE/BUILD/RACE/RESET)

Technik:
- Der Worker nutzt PUT /wellness/<YYYY-MM-DD> und schreibt das Patch-Objekt.

5) KLASSIFIKATION: GA vs KEY vs BENCH
-------------------------------------
5.1 Lauf-Erkennung
Eine Aktivit√§t z√§hlt als Lauf, wenn type ungef√§hr ‚Äûrun‚Äú ist:
- "run", "running", enth√§lt "run" oder enth√§lt "laufen"

5.2 Key-Einheit
Ein Lauf ist Key, wenn es einen Tag gibt:
- key:<irgendwas>

Beispiele:
- key:vo2
- key:schwelle
- key:tempo

Key-L√§ufe werden NICHT f√ºr GA-Kennzahlen (VDOT/Drift/Motor) genutzt.

5.3 GA (Grundlage)
GA wenn:
- kein key:*
- Dauer (moving_time oder elapsed_time) >= 30 Minuten

5.4 GA Comparable (f√ºr Motor & Diagnose)
Comparable GA wenn:
- kein key:*
- Dauer >= 35 Minuten
- Pace stabil genug (CV-Limit, siehe unten)

6) KENNZAHLEN IM DETAIL
-----------------------
6.1 Efficiency Factor (EF)
Aus Aktivit√§ts-Summary:
- EF = average_speed / average_heartrate

Wenn average_speed oder average_heartrate fehlen/0 sind => EF = null.

6.2 VDOT-like
F√ºr GA (nicht Key) wird gesetzt:
- VDOT = EF * 1200
Hinweis: ‚ÄûVDOT-like‚Äú ist ein skaliertes EF-Signal, kein offizieller VDOT.

6.3 HR-Drift (aus Streams)
Nur f√ºr GA (nicht Key), aus Streams:
- time
- velocity_smooth
- heartrate

Berechnung:
- Warmup wird standardm√§√üig √ºbersprungen (warmup_skip, Default 600 Sekunden)
- Danach werden nur Punkte genutzt, die:
  - HR >= 40
  - speed >= MIN_RUN_SPEED (Default 1.8 m/s)
- Verbleibende Punkte werden halbiert:
  - hr1 = mean(erste H√§lfte)
  - hr2 = mean(zweite H√§lfte)
- Drift in %:
  - hr_drift_pct = ((hr2 - hr1) / hr1) * 100

Negative Drift:
- Wenn Drift < 0 => wird verworfen (null) und nicht geschrieben.

6.4 Pace-Stabilit√§t (CV)
Aus den verwendeten Speed-Punkten:
- speed_cv = std(speed) / mean(speed)

F√ºr ‚ÄûGA comparable‚Äú gilt:
- speed_cv <= GA_SPEED_CV_MAX (Default 0.10)

6.5 Motor-Index (0..100)
Der Motor-Index ist ein Trend-Score aus vergleichbaren GA-L√§ufen.

Fenster:
- nutzt bis zu 56 Tage (2 x 28)
- recent vs prev basiert auf 28 Tagen
- Drift-Trend nutzt 14 Tage (recent14 vs prev14)

Vereinfacht:
- dv = % √Ñnderung EF-Median (recent vs prev), positiv ist gut
- dd = √Ñnderung Drift-Median (recent14 vs prev14), negativ ist gut
- Score startet bei 50, wird gemappt und auf 0..100 geklemmt:
  - EF wirkt st√§rker als Drift

Stale-Logik:
- Wenn der letzte comparable GA-Lauf √§lter als MOTOR_STALE_DAYS (Default 5) ist:
  => Motor = n/a

Motor-Text im Kommentar z.B.:
- "üèéÔ∏è Motor-Index: 68/100 (stabil) ‚Üë | EF Œî +1.2% (28d) | Drift Œî -0.7%-Pkt (14d)"

7) WELLNESS-KOMMENTAR: AUFBAU
-----------------------------
Jeder Tag bekommt einen Kommentar mit folgenden Bl√∂cken:

1) Tages-Status
- Heute: Kein Lauf / Grundlage (GA) / Schl√ºsseltraining (Key) / Gemischt (GA+Key)

2) Aerober Kontext (nur GA)
- Trend aus EF- und Drift-Vergleich (28 Tage recent vs prev)
- Ampel:
  - üü¢ Aerober Fortschritt: EF rauf UND Drift nicht schlechter (dd <= 0)
  - üî¥ Warnsignal: EF runter UND Drift schlechter (dv < -1.5 und dd > 1)
  - üü° sonst stabil/gemischt

3) Motor-Index
- siehe Kapitel 6.5

4) Bench Reports (optional)
- wenn bench:<name> Tag vorhanden ist

5) Mindest-Laufreiz (immer)
- 7-Tage Summe Run-Load (aus icu_training_load oder hr_load)
- Ziel: MIN_STIMULUS_7D_RUN_LOAD (Default 150)

8) BENCH REPORTS (bench:<name>)
-------------------------------
8.1 Bench-Tag setzen
Setze am Lauf einen Tag:
- bench:<name>

Beispiele:
- bench:GA45
- bench:vo2-5x3
- bench:schwelle-30

8.2 Was passiert an Bench-Tagen?
Der Worker erzeugt im Kommentar einen Report:
- Vergleich zu letztem Lauf mit gleichem bench:<name>
- Metriken:
  - EF: prozentual vs letztes
  - Drift: Delta %-Punkte vs letztes

Zus√§tzliche Metriken bei nicht-GA Bench (z.B. VO2/Schwelle/Interval):
- HRR60: Herzfrequenzabfall 60 Sekunden nach Peak
- VO2-Zeit: Zeit >= 90% HFmax (HFMAX ist fest im Code: 173)

9) MONTAGS-DETEKTIV (KALENDER NOTE)
----------------------------------
9.1 Wann?
- Jeden Montag (Monday-Erkennung √ºber UTC)

9.2 Was wird geschrieben?
Es wird ein Kalender-Event (Intervals Events API) erstellt/aktualisiert:
- category: NOTE
- name: Montags-Detektiv
- external_id: detektiv-YYYY-MM-DD
- start_date_local: YYYY-MM-DDT00:00:00
- color: orange
- description: Diagnose-Text (mehrzeilig)

9.3 Inhalte der Note
Die Note enth√§lt:
- Struktur: Runs/Woche, Minuten, Load, Longruns, Keys, GA/Kurz
- Belastungsbild: Monotony und Strain (einfaches Modell)
- Fundst√ºcke (Findings) und N√§chste Schritte (Actions)
- optional: GA comparable Messbasis (EF/Drift Median + Qualit√§ts-Hinweise)

Adaptive Fenster:
- versucht Fenster nacheinander: 14, 28, 42, 56, 84 Tage
- nimmt das erste Fenster, das als ‚Äûok‚Äú gilt

10) API / NUTZUNG
-----------------
10.1 Health Check
GET /
Antwort: "ok"

10.2 Watchface Endpoint
GET /watchface
Antwort: JSON (CORS-freundlich, kein Cache).

Optional:
- date=YYYY-MM-DD (sonst ‚Äûheute‚Äú)

10.3 Sync Endpoint
GET /sync

Parameter:

A) Range-Optionen
1) Einzelner Tag:
- date=YYYY-MM-DD

2) Explizit:
- from=YYYY-MM-DD&to=YYYY-MM-DD

3) Relativ (Default):
- days=14 (Clamp 1..31)
Wenn weder date noch from/to: newest=today, oldest=today-days.

B) Write / Debug
- write=true|false
  - true  => schreibt nach Intervals
  - false => nur rechnen (Achtung: im Nicht-Debug Modus wird trotzdem async gestartet)

- debug=true|false
  - true  => f√ºhrt synchron aus und gibt umfangreiche JSON-Ausgabe zur√ºck (inkl. patches)
  - false => startet asynchron (waitUntil) und antwortet sofort

C) Warmup Skip
- warmup_skip=600 (Sekunden; Default 600; 0..1800)

Beispiele:
- /sync?date=2026-01-20&write=true&debug=true
- /sync?days=7&write=false&debug=true
- /sync?from=2026-01-01&to=2026-01-14&write=true&warmup_skip=900

11) SCHEDULED TRIGGER
---------------------
Der Worker hat scheduled():
- l√§uft t√§glich
- syncRange √ºber gestern + heute
- write=true
- warmup_skip=600

Ziel: Jeden Tag mindestens Kommentar + Mindest-Laufreiz-Block.

12) TYPISCHE WORKFLOWS
----------------------
A) Erstes Setup testen (ohne Schreiben)
1) /sync?days=7&write=false&debug=true
2) Pr√ºfe JSON:
   - patches pro Tag
   - debug-Eintr√§ge: streams_failed, insufficient, negative_dropped, etc.

B) Schreiben aktivieren
- /sync?days=7&write=true&debug=true (einmalig kontrolliert)
- dann scheduled laufen lassen

C) Drift-Probleme debuggen
- debug=true nutzen
- debug[day][..] enth√§lt:
  - drift_raw
  - drift_source (z.B. streams_negative_dropped)

13) GRENZEN & HINWEISE
----------------------
- Negative Drift wird verworfen (Drift < 0 => null).
- Bei mehreren GA-L√§ufen am Tag k√∂nnen VDOT/Drift √ºberschrieben werden.
- Monday-Erkennung basiert auf UTC.

14) GLOSSAR
-----------
GA        = Grundlagenlauf (locker, >=30min, nicht key)
Key       = intensiver Lauf (Tag key:*)
EF        = Efficiency Factor = speed / HR
VDOT-like = EF skaliert (EF*1200)
Drift     = relative √Ñnderung HR zwischen erster und zweiter H√§lfte
Motor     = Trend-Score 0..100 aus EF- und Drift-Trends
Monotony  = mean(load)/sd(load) √ºber Tageslasten
Strain    = monotony * sum(load)

ENDE
